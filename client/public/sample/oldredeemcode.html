<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redeem Giftcode</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="./src/css/styles.css" />
  <link rel="stylesheet" href="./src/css/toast.css" />
  <link rel="website icon" href="./src/img/shapespeakicon.jpg" />

  <style>
    .code-box {
      font-family: monospace;
      letter-spacing: .12em;
    }

    .used-badge {
      background: rgba(220, 38, 38, .12);
      color: #ef4444;
      border: 1px solid rgba(220, 38, 38, .18);
    }

    .unused-badge {
      background: rgba(34, 197, 94, .12);
      color: #10b981;
      border: 1px solid rgba(34, 197, 94, .18);
    }
  </style>
</head>

<body class="min-h-screen text-white bg-gradient-to-b from-gray-900 to-black">
  <img id="background-img" src="./src/img/background.webp"
    class="fixed inset-0 w-full h-full object-cover opacity-10 pointer-events-none">

  <div id="Menu"></div>

  <main class="max-w-2xl mx-auto mt-24 px-4">
    <h1 class="text-2xl font-bold mb-4">Nhập giftcode</h1>

    <div class="bg-gray-800 p-6 rounded mb-4">
      <label class="block mb-2 text-sm text-gray-300">Nhập mã giftcode</label>
      <div class="flex gap-2">
        <input id="codeInput" class="flex-1 bg-gray-700 px-3 py-2 rounded text-white"
          placeholder="Nhập mã (ví dụ: ABCD1234)" />
        <button id="checkBtn" class="bg-amber-500 px-4 py-2 rounded text-black font-semibold">Kiểm tra</button>
      </div>
      <p class="text-xs text-gray-400 mt-2">Lưu ý: mã chỉ hợp lệ cho tài khoản đã mua.</p>
    </div>

    <div id="result" class="space-y-4"></div>
  </main>

  <div id="toast-container" class="fixed top-20 right-4 z-[1100] space-y-2 max-w-xs w-full"></div>

  <script type="module">
    import { db } from './src/js/firebase-config.js';
    import { showToast } from './src/js/toast.js';

    import {
      collection,
      query,
      where,
      getDocs,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const codeInput = document.getElementById("codeInput");
    const checkBtn = document.getElementById("checkBtn");
    const result = document.getElementById("result");

    const DEFAULT_EXCHANGE_RATE = 24000;
    function getCurrency() { return localStorage.getItem("currency") || "VND"; }
    function getExchangeRate() { const r = localStorage.getItem("exchangeRate"); return r ? Number(r) : DEFAULT_EXCHANGE_RATE; }
    function formatCurrency(amount) {
      const cur = getCurrency();
      if (cur === "USD") return `$${(amount / getExchangeRate()).toFixed(2)}`;
      return amount.toLocaleString("vi-VN") + " VND";
    }

    let currentUser = null;
    const auth = getAuth();
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (!user) {
        showToast("Vui lòng đăng nhập để nhập giftcode.", "warning");
      }
    });

    async function findGiftcodeByCode(code) {
      const q = query(collection(db, "giftcodes"), where("code", "==", code.trim()));
      const snap = await getDocs(q);
      return snap;
    }

    function renderGiftInfo(giftDoc) {
      const g = giftDoc.data();
      const id = giftDoc.id;
      console.log("renderGiftInfo - doc:", id, g);

      const total = (g.items || []).reduce((s, it) => s + (it.price || 0) * (it.quantity || 1), 0);
      const itemsHtml = (g.items || []).map(it => `
    <div class="flex items-center gap-3 mb-2">
      <img src="${it.picture || './src/img/shapespeakicon.jpg'}" class="w-12 h-12 rounded object-cover" />
      <div class="text-sm">
        <div class="text-yellow-400 font-semibold">${it.name}</div>
        <div class="text-gray-300">x${it.quantity} • ${formatCurrency(it.price)}</div>
      </div>
    </div>
  `).join("");

      // rewardLink hiện tại (nếu có)
      let rewardLink = (g.link || g.rewardLink || g.url || g.videoUrl || "").toString().trim();
      console.log("rewardLink:", rewardLink);

      result.innerHTML = `
    <div class="bg-gray-800 p-4 rounded">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-400 text-sm">Mã</p>
          <div class="code-box text-2xl font-bold">${g.code || ""}</div>
          <p class="text-xs text-gray-400 mt-1">${g.orderId ? `Đơn hàng: ${g.orderId}` : ""}</p>
        </div>
        <div class="text-right">
          <div class="${g.used ? 'used-badge px-3 py-1 rounded-full' : 'unused-badge px-3 py-1 rounded-full'}">${g.used ? 'Đã dùng' : 'Chưa dùng'}</div>
        </div>
      </div>

      <div class="mt-4 border-t border-gray-700 pt-3">
        ${itemsHtml}
        <div class="mt-2 flex justify-between items-center">
          <div class="text-gray-300">Tổng</div>
          <div class="text-white font-semibold">${formatCurrency(total)}</div>
        </div>
      </div>

      <div id="rewardArea" class="mt-4 border-t border-gray-700 pt-3">
        <p class="text-gray-300 text-sm mb-2">Liên kết nhận thưởng</p>

        <!-- nếu có link thì hiển thị anchor + Open + Copy -->
        ${rewardLink ? `
          <div class="flex items-center gap-3">
            <a id="rewardLinkAnchor" href="${rewardLink}" target="_blank" rel="noopener noreferrer"
               class="truncate block max-w-[60%] text-amber-300 underline">${rewardLink}</a>

            <button id="openRewardLinkBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-md text-sm flex items-center">
              <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i>
              <span>Mở</span>
            </button>

            <button id="copyRewardLinkBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md text-sm copy-btn flex items-center">
              <i class="fa-regular fa-copy mr-2"></i>
              <span>Sao chép</span>
            </button>
          </div>
        ` : `
          <!-- nếu chưa có link: hiển thị input inline + hai nút Lưu / Hủy -->
          <div id="noLinkBox" class="flex items-center gap-3">
            <input id="linkInput" type="url" placeholder="Nhập link nhận thưởng (ví dụ https://...)" 
                   class="flex-1 bg-gray-700 px-3 py-2 rounded text-white text-sm" />

            <button id="saveLinkBtn" class="bg-amber-500 hover:bg-amber-400 text-black px-3 py-2 rounded-md text-sm">Lưu liên kết</button>
            <button id="cancelLinkBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md text-sm">Hủy</button>
          </div>
          <div class="text-gray-400 text-sm mt-2">Chưa có liên kết thưởng trong dữ liệu. Bạn có thể thêm liên kết và lưu — hệ thống sẽ copy link tự động nếu lưu thành công.</div>
        `}
      </div>

      <div class="mt-4 flex gap-2">
        ${g.used ? '<button class="bg-gray-600 px-3 py-2 rounded text-sm cursor-not-allowed" disabled>Đã dùng</button>' : `<button id="useBtn" class="bg-amber-500 px-4 py-2 rounded text-black font-semibold">Dùng mã</button>`}
        <button id="backBtn" class="bg-gray-700 px-4 py-2 rounded text-sm">Nhập mã khác</button>
      </div>
    </div>
  `;

      // helper copy function
      async function copyToClipboard(text) {
        if (!text) return false;
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
          }
          return true;
        } catch (err) {
          console.error("Copy failed", err);
          return false;
        }
      }

      // validate url
      function isValidHttpUrl(str) {
        try {
          const u = new URL(str);
          return u.protocol === "http:" || u.protocol === "https:";
        } catch (_) {
          return false;
        }
      }

      // BACK button
      const backBtn = document.getElementById("backBtn");
      if (backBtn) backBtn.addEventListener("click", () => { result.innerHTML = ""; codeInput.focus(); });

      // OPEN button (nếu tồn tại)
      const openBtn = document.getElementById("openRewardLinkBtn");
      if (openBtn) {
        openBtn.addEventListener("click", () => {
          const linkNow = document.getElementById("rewardLinkAnchor")?.href || rewardLink;
          if (linkNow) window.open(linkNow, "_blank", "noopener");
          else showToast("Không có liên kết để mở.", "error");
        });
      }

      // COPY button (nếu tồn tại)
      const copyBtn = document.getElementById("copyRewardLinkBtn");
      if (copyBtn) {
        copyBtn.addEventListener("click", async () => {
          const linkNow = document.getElementById("rewardLinkAnchor")?.href || rewardLink;
          if (!linkNow) { showToast("Không có liên kết để sao chép.", "error"); return; }
          const ok = await copyToClipboard(linkNow);
          if (ok) {
            const span = copyBtn.querySelector("span");
            if (span) { span.textContent = "Đã sao chép"; setTimeout(() => (span.textContent = "Sao chép"), 1800); }
            showToast("Đã sao chép liên kết vào bộ nhớ tạm.", "success");
          } else showToast("Không thể sao chép liên kết.", "error");
        });
      }

      // nếu chưa có link: xử lý save/hủy inline
      const saveLinkBtn = document.getElementById("saveLinkBtn");
      const cancelLinkBtn = document.getElementById("cancelLinkBtn");
      const linkInputEl = document.getElementById("linkInput");

      if (cancelLinkBtn) {
        cancelLinkBtn.addEventListener("click", () => {
          // ẩn input -> trong cấu trúc hiện tại chúng ta re-render; nhưng đơn giản chỉ clear input
          if (linkInputEl) linkInputEl.value = "";
          showToast("Hủy thêm liên kết.", "info");
        });
      }

      if (saveLinkBtn) {
        saveLinkBtn.addEventListener("click", async () => {
          if (!currentUser) { showToast("Bạn cần đăng nhập để lưu liên kết.", "warning"); return; }

          let inputLink = linkInputEl?.value?.toString().trim() || "";
          if (!inputLink) {
            if (!confirm("Bạn chưa nhập liên kết. Muốn đánh dấu mã là đã dùng mà không lưu link không? (OK = đánh dấu, Cancel = hủy)")) return;
          } else if (!isValidHttpUrl(inputLink)) {
            if (!confirm("Liên kết có vẻ không hợp lệ. Bạn muốn lưu nó vẫn? (OK = lưu, Cancel = hủy)")) return;
          }

          // update data: luôn đánh dấu used:true khi user lưu từ giao diện này
          const updateData = { used: true, usedAt: new Date() };
          if (inputLink) updateData.link = inputLink;

          try {
            await updateDoc(doc(db, "giftcodes", id), updateData);
            showToast("Đã lưu liên kết và đánh dấu mã là đã dùng.", "success");

            // auto copy nếu có link
            const finalLink = inputLink || "";
            if (finalLink) {
              const copied = await copyToClipboard(finalLink);
              if (copied) showToast("Liên kết đã được sao chép vào clipboard — bạn có thể dán vào trình duyệt.", "success");
              else showToast("Không thể sao chép tự động; bạn có thể bấm Sao chép.", "warning");
            }

            // refresh re-render bằng cách fetch lại document
            try {
              const updatedSnap = await findGiftcodeByCode(g.code || "");
              if (!updatedSnap.empty) renderGiftInfo(updatedSnap.docs[0]);
              else result.innerHTML = "";
            } catch (refreshErr) { console.error("Refresh error:", refreshErr); }

          } catch (err) {
            console.error(err);
            showToast("Lỗi khi lưu liên kết. Vui lòng thử lại.", "error");
          }
        });
      }

      // USE button: nếu người dùng bấm Dùng mã (trước khi thêm link)
      const useBtn = document.getElementById("useBtn");
      if (useBtn) {
        useBtn.addEventListener("click", async () => {
          if (!currentUser) { showToast("Bạn cần đăng nhập để dùng mã.", "warning"); return; }
          if (g.uid && g.uid !== currentUser.uid) { showToast("Mã này không thuộc về tài khoản của bạn.", "error"); return; }
          if (g.used) { showToast("Mã đã được sử dụng trước đó.", "info"); return; }

          if (!confirm("Xác nhận dùng mã này? Hành động sẽ đánh dấu mã là đã sử dụng.")) return;

          // update used:true nhưng giữ nguyên link (nếu có)
          try {
            await updateDoc(doc(db, "giftcodes", id), { used: true, usedAt: new Date() });
            showToast("Đã đánh dấu mã là đã dùng.", "success");

            // nếu đã có link trước đó, auto copy và show
            if (rewardLink) {
              const copied = await copyToClipboard(rewardLink);
              if (copied) showToast("Liên kết đã được sao chép vào clipboard — bạn có thể dán vào trình duyệt.", "success");
              else showToast("Không thể sao chép tự động; bạn có thể bấm Sao chép.", "warning");
            }

            // refresh re-render
            try {
              const updatedSnap = await findGiftcodeByCode(g.code || "");
              if (!updatedSnap.empty) renderGiftInfo(updatedSnap.docs[0]);
              else result.innerHTML = "";
            } catch (refreshErr) { console.error("Refresh error:", refreshErr); }

          } catch (err) {
            console.error(err);
            showToast("Lỗi khi đổi mã. Vui lòng thử lại.", "error");
          }
        });
      }
    }


    checkBtn.addEventListener("click", async () => {
      const code = codeInput.value?.trim();
      if (!code) {
        showToast("Vui lòng nhập mã giftcode.", "warning");
        return;
      }
      if (!currentUser) {
        showToast("Vui lòng đăng nhập để sử dụng giftcode.", "warning");
        return;
      }

      try {
        const snap = await findGiftcodeByCode(code);
        if (snap.empty) {
          showToast("Mã không tồn tại.", "error");
          return;
        }

        // find first match (should be unique)
        const docSnap = snap.docs[0];
        const g = docSnap.data();

        // check owner first
        if (g.uid !== currentUser.uid) {
          showToast("Mã này không thuộc về tài khoản của bạn.", "error");
          return;
        }

        // render details and let user confirm to mark used
        renderGiftInfo(docSnap);
      } catch (err) {
        console.error(err);
        showToast("Lỗi khi kiểm tra mã", "error");
      }
    });

    // allow pressing Enter to check
    codeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkBtn.click();
    });
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const giftCode = params.get("giftCode");
      if (giftCode) {
        const codeInput = document.getElementById("codeInput");
        if (codeInput) {
          codeInput.value = giftCode;
          document.getElementById("checkBtn")?.click(); // tự động submit
        }
      }
    });

  </script>
</body>

</html>



