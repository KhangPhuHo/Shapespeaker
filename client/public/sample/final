const express = require('express');
const router = express.Router();
const { admin, firestore, messaging } = require('../firebaseAdmin');

/**
 * API: Check FCM token
 */
router.get("/checkFCMToken", async (req, res) => {
    const { userId } = req.query;
    if (!userId) return res.status(400).json({ success: false, message: "Thiáº¿u userId" });

    try {
        const tokensSnapshot = await firestore
            .collection("fcm_tokens")
            .doc(userId)
            .collection("tokens")
            .get();

        if (tokensSnapshot.empty) return res.json({ registered: false, tokens: [] });

        const tokens = tokensSnapshot.docs.map(doc => doc.id); // âš¡ dÃ¹ng doc.id
        return res.json({ registered: true, tokens, token: tokens[0] || null });
    } catch (error) {
        console.error("âŒ Lá»—i check FCM token:", error);
        return res.status(500).json({ success: false });
    }
});

/**
 * API: Save FCM token
 */
router.post('/saveFCMToken', async (req, res) => {
    const { userId, fcmToken, platform } = req.body;
    if (!userId || !fcmToken) return res.status(400).json({ success: false, message: 'Thiáº¿u userId hoáº·c fcmToken.' });

    try {
        const tokenRef = firestore
            .collection('fcm_tokens')
            .doc(userId)
            .collection('tokens')
            .doc(fcmToken);

        await tokenRef.set({
            fcmToken,
            platform: platform || 'web',
            lastUpdated: admin.firestore.FieldValue.serverTimestamp()
        });

        return res.json({ success: true, message: `ÄÃ£ lÆ°u token FCM cho user ${userId}.` });
    } catch (error) {
        console.error('âŒ Lá»—i lÆ°u FCM Token:', error);
        return res.status(500).json({ success: false, message: 'Lá»—i server khi lÆ°u token.' });
    }
});

/**
 * API: Delete FCM token
 */
router.post("/deleteFCMToken", async (req, res) => {
    const { userId, fcmToken } = req.body;
    if (!userId || !fcmToken) return res.status(400).json({ success: false, message: "Thiáº¿u userId hoáº·c fcmToken" });

    try {
        await firestore
            .collection('fcm_tokens')
            .doc(userId)
            .collection('tokens')
            .doc(fcmToken)
            .delete();

        return res.json({ success: true, message: "ÄÃ£ xÃ³a token" });
    } catch (err) {
        console.error("âŒ Lá»—i xÃ³a token:", err);
        return res.status(500).json({ success: false, message: "Lá»—i server khi xÃ³a token" });
    }
});

/**
 * Function: gá»­i notification khi Ä‘Æ¡n hÃ ng hoÃ n thÃ nh
 */
async function sendOrderCompleteNotification(userId, orderId, giftCode) {
    const snapshot = await firestore
        .collection('fcm_tokens')
        .doc(userId)
        .collection('tokens')
        .get();

    if (snapshot.empty) return { success: false, message: 'KhÃ´ng cÃ³ token Ä‘á»ƒ gá»­i.' };

    const tokens = snapshot.docs.map(d => d.id); // âš¡ dÃ¹ng doc.id

    const payload = {
        notification: {
            title: 'ðŸŽ‰ ÄÆ¡n hÃ ng hoÃ n thÃ nh!',
            body: `MÃ£ quÃ  táº·ng cá»§a báº¡n: ${giftCode}`,
            icon: 'https://shapespeaker.vercel.app/favicon.ico'
        },
        data: {
            type: 'ORDER_COMPLETE',
            order_id: orderId,
            giftcode: giftCode,
            user_id: userId,
            click_action: 'https://shapespeaker.vercel.app/giftcodes.html'
        }
    };

    try {
        const response = await messaging.sendMulticast({ tokens, ...payload });

        const invalidTokens = [];
        response.responses.forEach((resp, idx) => {
            if (!resp.success) {
                const err = resp.error?.code;
                if (err === 'messaging/invalid-argument' || err === 'messaging/registration-token-not-registered') {
                    invalidTokens.push(tokens[idx]);
                }
            }
        });

        if (invalidTokens.length > 0) {
            const batch = firestore.batch();
            invalidTokens.forEach(token => {
                batch.delete(firestore.collection('fcm_tokens').doc(userId).collection('tokens').doc(token));
            });
            await batch.commit();
        }

        return { success: true };
    } catch (error) {
        console.error('âŒ Lá»—i FCM:', error);
        return { success: false, message: error.message };
    }
}

/**
 * API: trigger hoÃ n thÃ nh Ä‘Æ¡n hÃ ng
 */
router.post('/completeOrder', async (req, res) => {
    const { userId, orderId } = req.body;
    if (!userId || !orderId) return res.status(400).json({ success: false, message: 'Thiáº¿u userId hoáº·c orderId.' });

    const giftCode = `GC-${orderId.slice(-4)}-${Math.floor(Math.random() * 999)}`;

    try {
        const result = await sendOrderCompleteNotification(userId, orderId, giftCode);
        return res.json({
            success: result.success,
            message: result.success ? `ðŸŽ ÄÃ£ gá»­i thÃ´ng bÃ¡o cho user ${userId}` : result.message,
            giftCode
        });
    } catch (error) {
        console.error("âŒ Lá»—i /completeOrder:", error);
        return res.status(500).json({ success: false, message: error.message });
    }
});

module.exports = router;


// fcm-register.js
import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-messaging.js";
import { auth } from "./firebase-config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

const SERVER_URL = "https://shapespeaker.onrender.com";

// DOM
const statusEl = document.getElementById("statusMessage");
const authEl = document.getElementById("authStatus");
const userEl = document.getElementById("userIdDisplay");
const tokenEl = document.getElementById("fcmTokenDisplay");
const toggleEl = document.getElementById("fcmToggle");

let currentUser = null;
let currentToken = null;

// Hiá»ƒn thá»‹ tráº¡ng thÃ¡i
function setStatus(text, type = "info") {
    statusEl.textContent = text;
    const colors = {
        info: "bg-gray-700 text-gray-200",
        success: "bg-green-600 text-white",
        error: "bg-red-600 text-white"
    };
    statusEl.className = `mt-4 p-4 rounded-lg text-center font-medium min-h-[4rem] ${colors[type]}`;
}

// Láº¥y VAPID key tá»« server
async function getVapidKeyFromServer() {
    try {
        const res = await fetch(`${SERVER_URL}/api/getVapidKey`);
        if (!res.ok) throw new Error("KhÃ´ng láº¥y Ä‘Æ°á»£c VAPID key");
        const data = await res.json();
        return data.vapidKey;
    } catch (err) {
        console.error(err);
        return null;
    }
}

// Chá» SW active
async function waitForSWActive(registration) {
    if (registration.active) return registration.active;

    return new Promise((resolve, reject) => {
        const sw = registration.installing || registration.waiting;
        if (!sw) return reject("No SW installing or waiting");

        sw.addEventListener('statechange', () => {
            if (sw.state === 'activated') resolve(sw);
        });

        setTimeout(() => reject("SW activation timed out"), 5000);
    });
}

// Auth listener
onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
        authEl.textContent = "ÄÃ£ Ä‘Äƒng nháº­p";
        userEl.textContent = user.uid;

        try {
            const res = await fetch(`${SERVER_URL}/notifications/checkFCMToken?userId=${user.uid}`);
            if (res.ok) {
                const data = await res.json();
                if (data.registered && data.tokens && data.tokens.length > 0) {
                    currentToken = data.tokens[0];
                    tokenEl.textContent = currentToken;
                    toggleEl.checked = true;
                    setStatus("ðŸ”” Thiáº¿t bá»‹ Ä‘Ã£ Ä‘Äƒng kÃ½ nháº­n thÃ´ng bÃ¡o.", "success");
                } else {
                    currentToken = null;
                    tokenEl.textContent = "ChÆ°a cÃ³";
                    toggleEl.checked = false;
                    setStatus("â„¹ï¸ Thiáº¿t bá»‹ chÆ°a Ä‘Äƒng kÃ½ nháº­n thÃ´ng bÃ¡o.", "info");
                }
            }
        } catch (err) {
            console.error(err);
        }
    } else {
        authEl.textContent = "ChÆ°a Ä‘Äƒng nháº­p";
        userEl.textContent = "N/A";
        tokenEl.textContent = "ChÆ°a cÃ³";
        toggleEl.checked = false;
        setStatus("âš ï¸ Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ nháº­n thÃ´ng bÃ¡o.", "info");
    }
});

// Báº­t FCM
async function enableFCM() {
    if (!currentUser) {
        setStatus("âš ï¸ Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c khi báº­t thÃ´ng bÃ¡o.", "error");
        toggleEl.checked = false;
        return;
    }

    if (!("Notification" in window)) {
        setStatus("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ thÃ´ng bÃ¡o.", "error");
        toggleEl.checked = false;
        return;
    }

    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
        setStatus("âŒ Báº¡n Ä‘Ã£ tá»« chá»‘i quyá»n thÃ´ng bÃ¡o.", "error");
        toggleEl.checked = false;
        return;
    }

    setStatus("â³ Láº¥y VAPID key tá»« server...");
    const VAPID_KEY = await getVapidKeyFromServer();
    if (!VAPID_KEY) {
        setStatus("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c VAPID key", "error");
        toggleEl.checked = false;
        return;
    }

    try {
        setStatus("â³ ÄÄƒng kÃ½ Service Worker...");
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        await waitForSWActive(registration);

        const messaging = getMessaging();
        const token = await getToken(messaging, {
            vapidKey: VAPID_KEY,
            serviceWorkerRegistration: registration
        });

        if (!token) throw new Error("KhÃ´ng láº¥y Ä‘Æ°á»£c token FCM");

        const res = await fetch(`${SERVER_URL}/notifications/saveFCMToken`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: currentUser.uid, fcmToken: token, platform: "web" })
        });

        if (res.ok) {
            currentToken = token;
            tokenEl.textContent = token;
            setStatus("ðŸŽ‰ Thiáº¿t bá»‹ Ä‘Ã£ Ä‘Äƒng kÃ½ nháº­n thÃ´ng bÃ¡o thÃ nh cÃ´ng!", "success");
        } else {
            const errData = await res.json().catch(() => ({}));
            setStatus(`âš ï¸ Lá»—i server: ${errData.message || res.statusText}`, "error");
            toggleEl.checked = false;
        }

    } catch (err) {
        console.error("SW hoáº·c FCM lá»—i:", err);
        setStatus("âŒ Lá»—i khi láº¥y hoáº·c gá»­i token FCM", "error");
        toggleEl.checked = false;
    }
}

// Táº¯t FCM
async function disableFCM() {
    if (!currentUser || !currentToken) {
        toggleEl.checked = false;
        return;
    }

    try {
        const res = await fetch(`${SERVER_URL}/notifications/deleteFCMToken`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: currentUser.uid, fcmToken: currentToken })
        });

        if (res.ok) {
            currentToken = null;
            tokenEl.textContent = "ChÆ°a cÃ³";
            setStatus("ðŸ”• ÄÃ£ há»§y Ä‘Äƒng kÃ½ nháº­n thÃ´ng bÃ¡o.", "info");
        } else {
            const err = await res.json().catch(() => ({}));
            setStatus("âŒ Lá»—i khi há»§y Ä‘Äƒng kÃ½ FCM", "error");
            toggleEl.checked = true;
        }
    } catch (err) {
        console.error(err);
        setStatus("âŒ Lá»—i khi há»§y Ä‘Äƒng kÃ½ FCM", "error");
        toggleEl.checked = true;
    }
}

// Toggle listener
export function handleToggleChange(e) {
    if (e.target.checked) enableFCM();
    else disableFCM();
}

// public/firebase-messaging-sw.js

// âš ï¸ DÃ¹ng compat build vÃ¬ SW sá»­ dá»¥ng API namespaced (firebase.messaging())
importScripts('https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.13.2/firebase-messaging-compat.js');

// Firebase config (copy tá»« project cá»§a báº¡n)
firebase.initializeApp({
    apiKey: "AIzaSyCu6mwsKL-O1GmNG4BNHFdGcuqAgrk8IhY",
    authDomain: "book-management-b7265.firebaseapp.com",
    projectId: "book-management-b7265",
    storageBucket: "book-management-b7265.appspot.com",
    messagingSenderId: "1046859996196",
    appId: "1:1046859996196:web:1fb51609ff2dc20c130cb1",
    measurementId: "G-ZYTCE1YML4"
});

// Láº¥y messaging instance
const messaging = firebase.messaging();

// =====================
// Background message handler
// =====================
messaging.onBackgroundMessage((payload) => {
    console.log('[firebase-messaging-sw.js] Received background message', payload);

    const notificationTitle = payload.notification?.title || 'ThÃ´ng bÃ¡o';
    const notificationOptions = {
        body: payload.notification?.body || '',
        icon: payload.notification?.icon || '/favicon.ico',
        data: payload.data || {}
    };

    self.registration.showNotification(notificationTitle, notificationOptions);
});

// =====================
// Notification click handler
// =====================
self.addEventListener('notificationclick', (event) => {
    event.notification.close();

    const clickAction = event.notification.data?.click_action || '/';
    event.waitUntil(
        clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
            for (const client of clientList) {
                // So sÃ¡nh URL báº±ng cÃ¡ch normalize Ä‘á»ƒ trÃ¡nh mismatch /?query hoáº·c trailing slash
                const clientUrl = new URL(client.url);
                const clickUrl = new URL(clickAction, self.location.origin);
                if (clientUrl.pathname === clickUrl.pathname && 'focus' in client) return client.focus();
            }
            if (clients.openWindow) return clients.openWindow(clickAction);
        })
    );
});

// =====================
// Debug log SW ready
// =====================
self.addEventListener('install', (event) => {
    console.log('[firebase-messaging-sw.js] SW installing...');
    self.skipWaiting(); // Ä‘áº£m báº£o SW active ngay
});

self.addEventListener('activate', (event) => {
    console.log('[firebase-messaging-sw.js] SW activated');
    event.waitUntil(self.clients.claim()); // claim clients ngay
});
