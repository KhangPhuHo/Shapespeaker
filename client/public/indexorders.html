<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng theo ngÆ°á»i dÃ¹ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="./src/css/styles.css" />
    <link rel="stylesheet" href="./src/css/toast.css" />
    <link rel="stylesheet" href="./src/css/menure.css" />
    <link rel="stylesheet" href="./src/css/chatbot.css" />
    <link rel="website icon" href="./src/img/shapespeakicon.jpg" />
</head>

<body class="bg-gray-900 min-h-screen">
    <div id="Menu"></div><br><br><br>
    <div id="bot"></div>

    <div class="max-w-6xl mx-auto mt-10 px-4 text-white">

        <!-- Ã” tÃ¬m kiáº¿m -->
        <input id="search" type="text"
            class="w-full mb-6 px-4 py-2 rounded-full bg-white/10 text-white placeholder-gray-400 border border-white/20 focus:outline-none focus:ring-2 focus:ring-pink-400 transition"
            placeholder="ğŸ” TÃ¬m theo tÃªn hoáº·c email..." />

        <!-- Danh sÃ¡ch ngÆ°á»i dÃ¹ng -->
        <div id="UserList" class="space-y-6 min-h-[300px]">
            <!-- CÃ³ thá»ƒ render thÃªm skeleton loading á»Ÿ Ä‘Ã¢y -->
            <div id="loading-users" class="text-center py-10 hidden">
                <span class="text-white text-sm animate-pulse">Äang táº£i dá»¯ liá»‡u ngÆ°á»i dÃ¹ng...</span>
            </div>
        </div>

        <!-- PhÃ¢n trang -->
        <div class="mt-10 flex justify-center gap-4">
            <button id="prevPage"
                class="px-5 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-full transition font-semibold shadow-md disabled:opacity-50 disabled:pointer-events-none">
                ã€ˆ Trang trÆ°á»›c
            </button>
            <button id="nextPage"
                class="px-5 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-full transition font-semibold shadow-md disabled:opacity-50 disabled:pointer-events-none">
                Trang sau ã€‰
            </button>
        </div>
    </div>


    <!-- Scripts -->
    <script type="module" src="./src/js/language.js" defer></script>
    <script type="module" src="./src/js/toast.js"></script>
    <script type="module" src="./src/js/firebase-config.js"></script>
    <script src="./src/js/menu.js"></script>
    <script type="module" src="./src/js/profile.js"></script>
    <script type="module" src="./src/js/logout.js"></script>
    <script type="module">
        import { addToCart } from './src/js/cart-utils.js';
        window.addToCart = addToCart;
    </script>
    <script type="module" src="./src/js/chatbot.js"></script>
    <script type="module">
        import { db } from './src/js/firebase-config.js';
        import { createAndSaveGiftCode } from './src/js/giftcode-utils.js';
        import { collection, query, orderBy, getDocs, getDoc, doc, updateDoc, where }
            from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
        import { showToast } from './src/js/toast.js';

        let usersWithOrders = [];
        let currentPage = 1;
        const usersPerPage = 15;

        document.getElementById("search").addEventListener("input", () => {
            currentPage = 1;
            renderPage();
        });

        async function fetchData() {
            const loading = document.getElementById("loading-users");
            if (loading) loading.classList.remove("hidden");

            try {
                const orderSnap = await getDocs(query(collection(db, "orders"), orderBy("date", "desc")));
                const orders = {};
                orderSnap.forEach(doc => {
                    const order = doc.data();
                    order.id = doc.id;
                    if (!orders[order.uid]) orders[order.uid] = [];
                    orders[order.uid].push(order);
                });

                const userSnap = await getDocs(collection(db, "users"));
                usersWithOrders = userSnap.docs.map(doc => {
                    const user = doc.data();
                    const uid = doc.id;
                    const list = orders[uid] || [];

                    if (list.length === 0) return null;

                    const totalSpent = list.reduce((sum, o) =>
                        o.status === "delivered"
                            ? sum + o.items.reduce((s, i) => s + i.price * i.quantity, 0)
                            : sum, 0
                    );

                    const highestPriority =
                        list.some(o => o.status === "shipped") ? 1 :
                            list.some(o => o.status === "processing") ? 2 :
                                list.some(o => o.status === "pending") ? 3 : 4;

                    const latestOrderTime = list[0]?.date?.toMillis() || 0;

                    return {
                        uid,
                        name: user.name || user.email || "(KhÃ´ng rÃµ)",
                        email: user.email || "",
                        avatar: user.avatar || "",
                        orders: list,
                        totalSpent,
                        highestPriority,
                        latestOrderTime
                    };
                }).filter(Boolean)
                    .sort((a, b) => {
                        if (a.highestPriority !== b.highestPriority) return a.highestPriority - b.highestPriority;
                        return b.latestOrderTime - a.latestOrderTime;
                    });

                
                renderPage(); // âœ… CHá»ˆ render sau khi cÃ³ dá»¯ liá»‡u
            } catch (error) {
                console.error("Lá»—i khi táº£i dá»¯ liá»‡u:", error);
                // CÃ³ thá»ƒ hiá»‡n toast lá»—i táº¡i Ä‘Ã¢y náº¿u báº¡n muá»‘n
            } finally {
                if (loading) loading.classList.add("hidden");
            }
        }

        function renderPage() {
            const searchText = document.getElementById("search").value.toLowerCase();
            const filtered = usersWithOrders.filter(user =>
                user.name.toLowerCase().includes(searchText) || user.email.toLowerCase().includes(searchText)
            );

            const start = (currentPage - 1) * usersPerPage;
            const end = start + usersPerPage;
            const usersPage = filtered.slice(start, end);

            const UserList = document.getElementById("UserList");
            UserList.innerHTML = "";

            usersPage.forEach(user => {
                const summaryStats = user.orders.reduce((acc, o) => {
                    acc[o.status] = (acc[o.status] || 0) + 1;
                    return acc;
                }, {});

                const container = document.createElement("div");
                container.className = "bg-gray-800 p-4 rounded-xl shadow-md";

                const statsText = `(${user.orders.length} Ä‘Æ¡n: ${Object.entries(summaryStats).map(([s, c]) => `${getStatusEmoji(s)} ${c}`).join(", ")}) ğŸ’° ${user.totalSpent.toLocaleString()} VND`;

                container.innerHTML = `
          <details open>
            <summary class="cursor-pointer text-lg text-yellow-300 font-semibold flex items-center gap-3">
              ${user.avatar ? `<img src="${user.avatar}" class="w-10 h-10 rounded-full border object-cover">` : ""}
              <div>
                ğŸ‘¤ ${user.name} (${user.email})
                <div class="text-sm text-gray-400 font-normal mt-1">${statsText}</div>
              </div>
            </summary>
            <div class="mt-4 space-y-4">
              ${user.orders.map(order => renderOrder(order)).join("")}
            </div>
          </details>
        `;

                UserList.appendChild(container);
            });
        }

        function renderOrder(order) {
            const total = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const date = order.date?.toDate().toLocaleString();
            const status = order.status;
            const cancelReason = order.cancelReason || "";
            const phone = order.phone || "(khÃ´ng cÃ³)";
            const address = order.address || "(khÃ´ng cÃ³)";

            return `
        <div class="bg-gray-700 rounded p-4">
        <div class="text-sm text-gray-300 mb-2 space-y-1">
            <div>ğŸ†” <b>${order.id}</b></div>
            <div>ğŸ“… NgÃ y Ä‘áº·t: ${date}</div>
            <div>ğŸ“ SÄT: ${phone}</div>
            <div>ğŸ“ Äá»‹a chá»‰: ${address}</div>
        </div>

          ${order.items.map(i => `
            <div class="flex gap-3 items-center mb-2">
              <img src="${i.picture || './src/img/shapespeakicon.jpg'}" class="w-14 h-14 rounded object-cover" />
              <div>
                <p class="text-yellow-400 font-semibold">${i.name}</p>
                <p class="text-gray-300 text-sm">x${i.quantity} â€¢ ${i.price.toLocaleString()} VND</p>
              </div>
            </div>`).join("")}
          <div class="flex justify-between items-center mt-2">
            <span class="font-bold">Tá»•ng: ${total.toLocaleString()} VND</span>
            <span class="text-sm px-3 py-1 rounded-full ${getStatusColor(status)}">${getStatusLabel(status)}</span>
          </div>
          ${status === "cancelled" && cancelReason ? `<p class="mt-2 text-red-400 italic">ğŸ“Œ LÃ½ do há»§y: ${cancelReason}</p>` : ""}
          ${status !== "cancelled" && status !== "delivered" ? `
            <div class="mt-4 flex gap-3 items-center">
              <select id="status-${order.id}" class="bg-gray-600 text-white px-2 py-1 rounded">
                <option value="pending" ${status === "pending" ? "selected" : ""}>â³ Äang chá»</option>
                <option value="processing" ${status === "processing" ? "selected" : ""}>ğŸ”§ Äang xá»­ lÃ½</option>
                <option value="shipped" ${status === "shipped" ? "selected" : ""}>ğŸšš Äang giao</option>
                <option value="delivered" ${status === "delivered" ? "selected" : ""}>âœ… ÄÃ£ giao</option>
              </select>
              <button onclick="window.updateStatus('${order.id}')" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded">LÆ°u</button>
              <button onclick="window.cancelOrder('${order.id}')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded">Há»§y Ä‘Æ¡n</button>
            </div>` : ""}
        </div>`;
        }

        function getStatusLabel(status) {
            return {
                pending: "â³ Äang chá»",
                processing: "ğŸ”§ Äang xá»­ lÃ½",
                shipped: "ğŸšš Äang giao",
                delivered: "âœ… ÄÃ£ giao",
                cancelled: "âŒ ÄÃ£ há»§y"
            }[status] || "â“";
        }

        function getStatusEmoji(status) {
            return getStatusLabel(status).split(" ")[0];
        }

        function getStatusColor(status) {
            return {
                pending: "bg-yellow-600",
                processing: "bg-indigo-600",
                shipped: "bg-blue-600",
                delivered: "bg-green-600",
                cancelled: "bg-red-600"
            }[status] || "bg-gray-600";
        }


        const SERVER_URL = "https://shapespeaker.onrender.com";

        window.updateStatus = async function (orderId) {
            const select = document.getElementById(`status-${orderId}`);
            if (!select) return;
            const newStatus = select.value;

            const orderRef = doc(db, "orders", orderId);

            try {
                // Láº¥y snapshot cÅ© Ä‘á»ƒ láº¥y userId
                const orderSnapBefore = await getDoc(orderRef);
                if (!orderSnapBefore.exists()) {
                    showToast("âŒ ÄÆ¡n hÃ ng khÃ´ng tá»“n táº¡i", "error");
                    return;
                }
                const orderDataBefore = orderSnapBefore.data();
                const userId = orderDataBefore.uid;

                // 1ï¸âƒ£ Cáº­p nháº­t tráº¡ng thÃ¡i trong Firestore
                await updateDoc(orderRef, { status: newStatus });
                showToast("âœ… ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i", "success");

                // 2ï¸âƒ£ Náº¿u delivered â†’ gá»i backend Ä‘á»ƒ táº¡o giftcode + gá»­i FCM
                if (newStatus === "delivered") {
                    try {
                        const API_URL = `${SERVER_URL}/notifications/completeOrder`;

                        const res = await fetch(API_URL, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ userId, orderId })
                        });

                        let data = {};
                        try {
                            data = await res.json();
                        } catch (err) {
                            console.error("âŒ KhÃ´ng parse Ä‘Æ°á»£c JSON:", err);
                        }

                        if (!res.ok) {
                            showToast(`âš ï¸ Lá»—i gá»­i thÃ´ng bÃ¡o: ${data.message || res.statusText}`, "warning");
                        } else {
                            showToast(`ğŸ Giftcode: ${data.giftCode} | ğŸ”” ThÃ´ng bÃ¡o Ä‘Ã£ gá»­i FCM`, "info");
                        }

                    } catch (err) {
                        console.error("âŒ Lá»—i gá»i API FCM:", err);
                        showToast("âŒ Lá»—i khi gá»­i thÃ´ng bÃ¡o FCM", "error");
                    }
                }

                // 3ï¸âƒ£ Refresh UI
                fetchData();

            } catch (e) {
                console.error(e);
                showToast("âŒ Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i", "error");
            }
        };

        window.cancelOrder = async function (orderId) {
            const reason = prompt("Nháº­p lÃ½ do há»§y Ä‘Æ¡n hÃ ng nÃ y:");
            if (!reason || reason.trim() === "") {
                alert("âš ï¸ Báº¡n pháº£i nháº­p lÃ½ do.");
                return;
            }

            try {
                const orderRef = doc(db, "orders", orderId);
                const orderSnap = await getDoc(orderRef);

                if (!orderSnap.exists()) {
                    showToast("âŒ KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng!", "error");
                    return;
                }

                const orderData = orderSnap.data();
                const items = orderData.items || [];

                // âœ… HoÃ n láº¡i stock cho tá»«ng sáº£n pháº©m
                for (const item of items) {
                    const productRef = doc(db, "shapespeakitems", item.id);
                    const productSnap = await getDoc(productRef);
                    if (productSnap.exists()) {
                        const currentStock = productSnap.data().stock || 0;
                        await updateDoc(productRef, {
                            stock: currentStock + item.quantity,
                        });
                    }
                }

                // âœ… Cáº­p nháº­t tráº¡ng thÃ¡i & lÃ½ do
                await updateDoc(orderRef, {
                    status: "cancelled",
                    cancelReason: reason.trim(),
                });

                showToast("ğŸ—‘ï¸ ÄÃ£ há»§y Ä‘Æ¡n vÃ  hoÃ n kho", "success");
                fetchData();
            } catch (e) {
                console.error(e);
                showToast("âŒ KhÃ´ng thá»ƒ há»§y Ä‘Æ¡n", "error");
            }
        };


        document.getElementById("prevPage").onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        };
        document.getElementById("nextPage").onclick = () => {
            if (currentPage * usersPerPage < usersWithOrders.length) {
                currentPage++;
                renderPage();
            }
        };

        fetchData();
    </script>
</body>

</html>