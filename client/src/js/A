// ğŸ‘‰ TÃ¡ch hÃ m ra Ä‘á»ƒ dá»… dÃ¹ng láº¡i
function extractEntities(entities) {
  return {
    product: entities['product:product']?.[0]?.value || null,
    quantity: entities['wit$number:number']?.[0]?.value || null,
    category: entities['category:category']?.[0]?.value || null,
  };
}

async function getWitResponse(input) {
  try {
    const res = await fetch("https://shapespeaker.onrender.com/wit/message", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ input }),
    });
    const data = await res.json();

    let intent = 'none';
    if (data.intents && data.intents.length > 0) {
      intent = data.intents[0].name;
    }

    const entities = data.entities || {};
    const { product, quantity, category } = extractEntities(entities);

    // âœ… Cáº­p nháº­t context náº¿u cÃ³ dá»¯ liá»‡u má»›i
    if (product) conversationContext.lastProduct = product;
    if (quantity) conversationContext.lastQuantity = quantity;
    conversationContext.lastIntent = intent;

    switch (intent) {
      case 'greeting':
        return 'Xin chÃ o! TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n?';

      case 'ask_product':
        try {
          const witServerRes = await fetch("https://shapespeaker.onrender.com/wit/get-product-info", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const witData = await witServerRes.json();
          return witData.reply;
        } catch (error) {
          console.error("âŒ Lá»—i gá»i server:", error);
          return "Xin lá»—i, khÃ´ng thá»ƒ láº¥y thÃ´ng tin sáº£n pháº©m lÃºc nÃ y.";
        }

      case 'products_by_category':
        try {
          const witServerRes = await fetch("https://shapespeaker.onrender.com/wit/products-by-category", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input, entities }),
          });
          const witData = await witServerRes.json();
          return witData.reply;
        } catch (error) {
          console.error("âŒ Lá»—i gá»i server:", error);
          return "Xin lá»—i, khÃ´ng thá»ƒ láº¥y sáº£n pháº©m theo danh má»¥c lÃºc nÃ y.";
        }

      case 'get_price_of_product':
        try {
          const witServerRes = await fetch("https://shapespeaker.onrender.com/wit/product-price", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              input,
              entities,
              fallbackProduct: conversationContext.lastProduct,
            }),
          });
          const witData = await witServerRes.json();
          return witData.reply;
        } catch (error) {
          console.error("âŒ Lá»—i láº¥y giÃ¡:", error);
          return "Xin lá»—i, khÃ´ng thá»ƒ láº¥y giÃ¡ sáº£n pháº©m lÃºc nÃ y.";
        }

      case 'check_stock':
        try {
          const witServerRes = await fetch("https://shapespeaker.onrender.com/wit/check-stock", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              input,
              entities,
              fallbackProduct: conversationContext.lastProduct,
              fallbackQuantity: conversationContext.lastQuantity,
            }),
          });
          const witData = await witServerRes.json();
          return witData.reply;
        } catch (error) {
          console.error("âŒ Lá»—i kiá»ƒm tra tá»“n kho:", error);
          return "Xin lá»—i, khÃ´ng thá»ƒ kiá»ƒm tra tá»“n kho lÃºc nÃ y.";
        }

      case 'compare_price':
        try {
          const witServerRes = await fetch("https://shapespeaker.onrender.com/wit/compare-price", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input }),
          });
          const witData = await witServerRes.json();
          return witData.reply;
        } catch (error) {
          console.error("âŒ Lá»—i so sÃ¡nh giÃ¡:", error);
          return "Xin lá»—i, khÃ´ng thá»ƒ so sÃ¡nh giÃ¡ lÃºc nÃ y.";
        }

      case 'buy_product':
        if (conversationContext.lastProduct && conversationContext.lastQuantity) {
          return `âœ… ÄÃ£ ghi nháº­n báº¡n muá»‘n mua ${conversationContext.lastQuantity} cÃ¡i ${conversationContext.lastProduct}. Vui lÃ²ng vÃ o trang chi tiáº¿t Ä‘á»ƒ hoÃ n táº¥t.`;
        }
        return 'Váº­y báº¡n hÃ£y chá»n vÃ o sáº£n pháº©m, sau Ä‘Ã³ chá»n vÃ o nÃºt mua ngay hoáº·c giá» hÃ ng, thÃªm thÃ´ng tin lÃ  Ä‘Æ°á»£c';

      case 'ask_features':
        return 'TÃ´i cÃ³ chá»©c nÄƒng trÃ² chuyá»‡n, giáº£i Ä‘Ã¡p cÃ¡c tháº¯c máº¯c cá»§a báº¡n vá» sáº£n pháº©m vÃ  dá»‹ch vá»¥ bÃªn chÃºng tÃ´i';

      case 'thank':
        return 'Cáº£m Æ¡n báº¡n vÃ¬ Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥ bÃªn mÃ¬nh';

      case 'goodbye':
        return 'Cáº£m Æ¡n báº¡n, háº¹n gáº·p láº¡i!';

      default:
        return 'TÃ´i chÆ°a hiá»ƒu rÃµ Ã½ báº¡n, báº¡n cÃ³ thá»ƒ nÃ³i láº¡i khÃ´ng?';
    }

  } catch (error) {
    console.error('Lá»—i gá»i Wit.ai:', error);
    return 'Xin lá»—i, cÃ³ lá»—i khi xá»­ lÃ½ yÃªu cáº§u cá»§a báº¡n.';
  }
}

// ğŸ” Wit proxy: gá»i Wit API tá»« backend Ä‘á»ƒ giáº¥u token
app.post("/wit/message", async (req, res) => {
  const { input } = req.body;

  if (!input) {
    return res.status(400).json({ error: "Thiáº¿u input" });
  }

  try {
    const response = await fetch(`https://api.wit.ai/message?v=20230616&q=${encodeURIComponent(input)}`, {
      headers: {
        Authorization: `Bearer ${process.env.WIT_ACCESS_TOKEN}`,
      },
    });

    const data = await response.json();
    return res.json(data);

  } catch (error) {
    console.error("âŒ Lá»—i gá»i Wit.ai:", error);
    return res.status(500).json({ error: "Lá»—i khi gá»i Wit.ai" });
  }
});


app.post("/wit/get-product-info", async (req, res) => {
  try {
    console.log("ğŸ“¥ [get-product-info] Nháº­n request:", req.body); // log input

    const snapshot = await admin.firestore().collection("shapespeakitems")
      .orderBy("createdAt", "desc")
      .limit(3)
      .get();

    if (snapshot.empty) {
      return res.json({ reply: "Hiá»‡n chÆ°a cÃ³ sáº£n pháº©m nÃ o trong há»‡ thá»‘ng." });
    }

    const products = [];
    snapshot.forEach(doc => {
      const d = doc.data();
      products.push(`${d.name} - ${d.price.toLocaleString()} VND`);
    });

    return res.json({
      reply: `ğŸ“¦ Má»™t sá»‘ sáº£n pháº©m bÃªn mÃ¬nh:\n- ${products.join('\n- ')}\nBáº¡n cÃ³ thá»ƒ gÃµ tÃªn sáº£n pháº©m hoáº·c chá»n trá»±c tiáº¿p Ä‘á»ƒ xem thÃªm nhÃ©.`
    });

  } catch (error) {
    console.error("âŒ Lá»—i get-product-info:", error);
    return res.status(500).json({ reply: "âŒ KhÃ´ng thá»ƒ láº¥y thÃ´ng tin sáº£n pháº©m." });
  }
});