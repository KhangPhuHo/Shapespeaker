<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="title.redeem">Redeem Giftcode</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="./src/css/styles.css" />
  <link rel="stylesheet" href="./src/css/toast.css" />
  <link rel="stylesheet" href="./src/css/menure.css" />
  <link rel="stylesheet" href="./src/css/chatbot.css">
  <link rel="website icon" href="./src/img/shapespeakicon.jpg" />

  <style>
    .code-box {
      font-family: monospace;
      letter-spacing: .12em;
    }

    .used-badge {
      background: rgba(220, 38, 38, .12);
      color: #ef4444;
      border: 1px solid rgba(220, 38, 38, .18);
    }

    .unused-badge {
      background: rgba(34, 197, 94, .12);
      color: #10b981;
      border: 1px solid rgba(34, 197, 94, .18);
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-gray-900 to-black">
  <img id="background-img" src="./src/img/background.webp"
    class="fixed inset-0 w-full h-full object-cover opacity-10 pointer-events-none">

  <div id="Menu"></div>
  <div id="bot"></div>

  <main class="text-white max-w-2xl mx-auto mt-24 px-4">
    <h1 class="text-2xl font-bold mb-4" data-i18n="redeem.input_giftcode">Nhập mã giftcode</h1>

    <div class="bg-gray-800 p-6 rounded mb-4">
      <label class="block mb-2 text-sm text-gray-300" data-i18n="redeem.input_giftcode">Nhập mã giftcode</label>
      <div class="flex gap-2">
        <input id="codeInput" class="flex-1 bg-gray-700 px-3 py-2 rounded text-white"
          placeholder="Nhập mã (ví dụ: ABCD1234)" data-i18n="redeem.input_placeholder" />
        <button id="checkBtn" class="bg-amber-500 px-4 py-2 rounded text-black font-semibold"
          data-i18n="redeem.check">Kiểm tra</button>
      </div>
      <p class="text-xs text-gray-400 mt-2" data-i18n="redeem.owner_note">Lưu ý: mã chỉ hợp lệ cho tài khoản đã mua.</p>
    </div>

    <div id="result" class="space-y-4"></div>
  </main>

  <div id="toast-container" class="fixed top-20 right-4 z-[1100] space-y-2 max-w-xs w-full"></div>

  <!-- Scripts -->
  <script type="module" src="./src/js/language.js" defer></script>
  <script type="module" src="./src/js/toast.js"></script>
  <script type="module" src="./src/js/firebase-config.js"></script>
  <script src="./src/js/menu.js"></script>
  <script type="module" src="./src/js/profile.js"></script>
  <script type="module" src="./src/js/logout.js"></script>
  <script type="module">
    import { addToCart } from './src/js/cart-utils.js';
    window.addToCart = addToCart;
  </script>
  <script type="module" src="./src/js/chatbot.js"></script>
  <script type="module">
    import { enableSessionKeepAlive } from "./src/js/session-keeper.js";
    enableSessionKeepAlive();
  </script>

  <script type="module">
    import { db } from './src/js/firebase-config.js';
    import { setLanguage, getTranslation } from './src/js/language.js';
    import { showToast } from './src/js/toast.js';

    import {
      collection, query, where, getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const codeInput = document.getElementById("codeInput");
    const checkBtn = document.getElementById("checkBtn");
    const result = document.getElementById("result");

    const DEFAULT_EXCHANGE_RATE = 24000;
    function getCurrency() { return localStorage.getItem("currency") || "VND"; }
    function getExchangeRate() { return Number(localStorage.getItem("exchangeRate") || DEFAULT_EXCHANGE_RATE); }
    function formatCurrency(amount) {
      return getCurrency() === "USD"
        ? `$${(amount / getExchangeRate()).toFixed(2)}`
        : amount.toLocaleString("vi-VN") + " VND";
    }

    let currentUser = null;
    const auth = getAuth();
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) showToast(await getTranslation("redeem.need_login"), "warning");
    });


    /* -------------------- FIND GIFTCODE -------------------- */
    async function findGiftcodeByCode(code) {
      const q = query(collection(db, "giftcodes"), where("code", "==", code.trim()));
      return await getDocs(q);
    }


    /* -------------------- RENDER GIFTCODE INFO -------------------- */
    async function renderGiftInfo(giftDoc) {
      const g = giftDoc.data();
      const id = giftDoc.id;

      const total = (g.items || []).reduce((s, it) => s + it.price * it.quantity, 0);
      const itemsHtml = (g.items || []).map(it => `
      <div class="flex items-center gap-3 mb-2">
        <img src="${it.picture || './src/img/shapespeakicon.jpg'}" class="w-12 h-12 rounded object-cover" />
        <div class="text-sm">
          <div class="text-yellow-400 font-semibold">${it.name}</div>
          <div class="text-gray-300">x${it.quantity} • ${formatCurrency(it.price)}</div>
        </div>
      </div>
    `).join("");

      const rewardLink = g.link?.trim() || "";

      result.innerHTML = `
      <div class="bg-gray-800 p-4 rounded" data-i18n-container>
        <div class="flex justify-between items-start">
          <div>
            <p class="text-gray-400 text-sm" data-i18n="redeem.code">Mã</p>
            <div class="code-box text-2xl font-bold">${g.code}</div>
            <p class="text-xs text-gray-400 mt-1">${g.orderId ? `${await getTranslation("redeem.order")}: ${g.orderId}` : ""}</p>
          </div>

          <div class="text-right">
            <span class="${g.used ? "used-badge" : "unused-badge"} px-3 py-1 rounded-full" 
              data-i18n="${g.used ? "redeem.used" : "redeem.unused"}">
              ${g.used ? "Đã dùng" : "Chưa dùng"}
            </span>
          </div>
        </div>

        <div class="mt-4 border-t border-gray-700 pt-3">
          ${itemsHtml}
          <div class="mt-2 flex justify-between items-center">
            <div class="text-gray-300" data-i18n="redeem.total">Tổng</div>
            <div class="text-white font-semibold">${formatCurrency(total)}</div>
          </div>
        </div>

        <div class="mt-4 border-t border-gray-700 pt-3">
          <p class="text-gray-300 text-sm mb-2" data-i18n="redeem.reward_link">Liên kết nhận thưởng</p>

          ${g.used
          ? `
              <div class="flex items-center gap-3">
                <div class="flex-1 bg-gray-700 px-3 py-2 rounded text-amber-300 text-sm truncate">${rewardLink || "—"}</div>

                <button id="openRewardLinkBtn" 
                  class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-md text-sm"
                  ${rewardLink ? "" : "disabled"}>
                  ${await getTranslation("redeem.open")}
                </button>

                <button id="copyRewardLinkBtn" 
                  class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md text-sm"
                  ${rewardLink ? "" : "disabled"}>
                  ${await getTranslation("redeem.copy")}
                </button>
              </div>

              <div class="text-gray-400 text-sm mt-2" data-i18n="redeem.used_note">
                Mã đã được sử dụng. Bạn có thể mở hoặc sao chép liên kết.
              </div>
            `
          : `
                <div class="flex items-center gap-3">
                  <div class="flex-1 bg-gray-700 px-3 py-2 rounded text-amber-300 text-sm truncate">—</div>
                </div>
                <div class="text-gray-400 text-sm mt-2" data-i18n="redeem.not_used_note">
                  Khi bạn bấm "Dùng mã", liên kết sẽ được kích hoạt.
                </div>
            `
        }
        </div>

        <div class="mt-4 flex gap-2">
          ${g.used
          ? `<button disabled class="bg-gray-600 px-3 py-2 rounded text-sm" data-i18n="redeem.used">Đã dùng</button>`
          : `<button id="useBtn" class="bg-amber-500 px-4 py-2 rounded text-black font-semibold" data-i18n="redeem.use">Dùng mã</button>`
        }
          <button id="backBtn" class="bg-gray-700 px-4 py-2 rounded text-sm" data-i18n="redeem.back">Nhập mã khác</button>
        </div>
      </div>
    `;

      /* Apply language */
      const lang = localStorage.getItem("lang") || "en";
      await setLanguage(lang);

      /* Nút Back */
      document.getElementById("backBtn")?.addEventListener("click", () => {
        result.innerHTML = "";
        codeInput.focus();
      });

      /* Nút Mở */
      document.getElementById("openRewardLinkBtn")?.addEventListener("click", () => {
        if (rewardLink) window.open(rewardLink, "_blank", "noopener");
      });

      /* Nút Sao chép */
      document.getElementById("copyRewardLinkBtn")?.addEventListener("click", async () => {
        await navigator.clipboard.writeText(rewardLink);
        showToast(await getTranslation("toast.copy_success"), "success");
      });

      /* Nút Dùng mã */
      document.getElementById("useBtn")?.addEventListener("click", async () => {
        if (!confirm(await getTranslation("redeem.confirm_use"))) return;

        await updateDoc(doc(db, "giftcodes", id), { used: true, usedAt: new Date() });
        showToast(await getTranslation("redeem.used_success"), "success");

        const refreshed = await findGiftcodeByCode(g.code);
        if (!refreshed.empty) renderGiftInfo(refreshed.docs[0]);
      });
    }


    /* -------------------- CHECK BUTTON -------------------- */
    checkBtn.addEventListener("click", async () => {
      const code = codeInput.value.trim();
      if (!code) return showToast(await getTranslation("redeem.enter_code"), "warning");
      if (!currentUser) return showToast(await getTranslation("redeem.need_login"), "warning");

      const snap = await findGiftcodeByCode(code);
      if (snap.empty) return showToast(await getTranslation("redeem.not_found"), "error");

      const docSnap = snap.docs[0];
      const g = docSnap.data();

      if (g.uid !== currentUser.uid)
        return showToast(await getTranslation("redeem.not_owner"), "error");

      renderGiftInfo(docSnap);
    });

    codeInput.addEventListener("keydown", e => {
      if (e.key === "Enter") checkBtn.click();
    });

    /* AUTO LOAD GIFT CODE FROM URL */
    document.addEventListener("DOMContentLoaded", async () => {
      const lang = localStorage.getItem("lang") || "en";
      await setLanguage(lang);

      const params = new URLSearchParams(window.location.search);
      const giftCode = params.get("giftCode");

      if (giftCode) {
        codeInput.value = giftCode;
        checkBtn.click();
      }
    });

    /* LISTEN LANGUAGE CHANGE */
    document.addEventListener("languageChanged", async () => {
      const lang = localStorage.getItem("lang") || "en";
      await setLanguage(lang);
    });
    window.addEventListener("storage", e => {
      if (e.key === "lang") document.dispatchEvent(new Event("languageChanged"));
    });
  </script>

</body>

</html>